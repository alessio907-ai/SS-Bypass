# ==============================
# CrystalPVPJarTester BLUE UI
# SAME LOGIC – BLUE DESIGN ONLY
# ==============================

$ErrorActionPreference = "SilentlyContinue"

function Start-CheatScan {
    Clear-Host
    Write-Host "═══════════════════════════════════════" -ForegroundColor DarkBlue
    Write-Host " CrystalPVP Cheat Analyser" -ForegroundColor Cyan
    Write-Host " Made by Main2Packet | Blue UI" -ForegroundColor Blue
    Write-Host "═══════════════════════════════════════" -ForegroundColor DarkBlue
    Write-Host ""

    # ---- Minecraft uptime ----
    $process = Get-Process javaw,java -ErrorAction SilentlyContinue | Select-Object -First 1
    if ($process) {
        try {
            $uptime = (Get-Date) - $process.StartTime
            Write-Host "{ Minecraft Uptime }" -ForegroundColor Cyan
            Write-Host "$($process.Name) PID $($process.Id) running for $($uptime.Hours)h $($uptime.Minutes)m $($uptime.Seconds)s" -ForegroundColor Blue
            Write-Host ""
        } catch {}
    }

    Write-Host "Searching for running Minecraft instance..." -ForegroundColor Blue

    $mcPath = Get-RunningMinecraftPath
    if (-not $mcPath) {
        Write-Host "✖ No running Minecraft instance found." -ForegroundColor Red
        Read-Host "Press Enter to exit"
        return
    }

    $modsPath = Join-Path $mcPath "mods"
    if (-not (Test-Path $modsPath)) {
        Write-Host "✖ Mods folder not found:" -ForegroundColor Red
        Write-Host "  $modsPath" -ForegroundColor Red
        Read-Host "Press Enter to exit"
        return
    }

    $mods = Get-ChildItem $modsPath -Filter "*.jar"
    if ($mods.Count -eq 0) {
        Write-Host "⚠ No mods found." -ForegroundColor Yellow
        Read-Host "Press Enter"
        return
    }

    Write-Host ""
    Write-Host "{ Detected Instance }" -ForegroundColor Cyan
    Write-Host $mcPath -ForegroundColor Blue
    Write-Host ""

    $flagged = @()
    $clean   = @()
    $i = 0

    foreach ($mod in $mods) {
        $i++
        Write-Host "`r[~] Scanning $i / $($mods.Count)" -NoNewline -ForegroundColor Cyan
        $res = Analyze-Mod $mod.FullName $mod.Name
        if ($res.IsSuspicious) { $flagged += $res } else { $clean += $res }
    }

    Write-Host "`r$(' ' * 80)`r"

    if ($clean.Count -gt 0) {
        Write-Host "{ Clean Mods }" -ForegroundColor Cyan
        foreach ($m in $clean) {
            Write-Host " > $($m.ModName)" -ForegroundColor Blue
        }
        Write-Host ""
    }

    if ($flagged.Count -gt 0) {
        Write-Host "{ Cheat Mods }" -ForegroundColor DarkBlue
        foreach ($m in $flagged) {
            Write-Host " > $($m.ModName)" -ForegroundColor Red
            Write-Host "   Reason: $($m.Reason)" -ForegroundColor Magenta
            if ($m.Hits.Count -gt 0) {
                Write-Host "   Hits:   $($m.Hits -join ', ')" -ForegroundColor Yellow
            }
        }
        Write-Host ""
    }

    if ($flagged.Count -eq 0) {
        Write-Host "✔ No suspicious mods detected." -ForegroundColor Cyan
    }

    Write-Host ""
    Write-Host "Scan finished at $(Get-Date)" -ForegroundColor Blue
    Read-Host "Press Enter to exit"
}

# -------------------------------
# EVERYTHING BELOW = UNCHANGED
# -------------------------------

function Get-RunningMinecraftPath {
    $java = Get-Process java,javaw -ErrorAction SilentlyContinue | Sort-Object StartTime -Descending
    foreach ($p in $java) {
        try {
            $cmd = (Get-CimInstance Win32_Process -Filter "ProcessId=$($p.Id)").CommandLine
            if ($cmd -match "-gameDir\s+""([^""]+)""") {
                if (Test-Path "$($matches[1])\mods") { return $matches[1] }
            }
            if ($cmd -match "([A-Za-z]:\\[^""]*?\.minecraft)") {
                if (Test-Path "$($matches[1])\mods") { return $matches[1] }
            }
        } catch {}
    }
    return $null
}

function Analyze-Mod($JarPath, $ModName) {
    $temp = Join-Path $env:TEMP ("cpvp_" + [guid]::NewGuid())
    New-Item $temp -ItemType Directory | Out-Null

    $hits = @()
    $suspicious = $false
    $reasons = @()

    try {
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        [IO.Compression.ZipFile]::ExtractToDirectory($JarPath, $temp)

        $pkg = Scan-CheatPackages $temp
        $cls = Scan-SuspiciousClasses $temp

        if ($pkg.Hits.Count -gt 0) {
            $suspicious = $true
            $reasons += "Known cheat package detected"
            $hits += $pkg.Hits
        }

        if ($cls.Hits.Count -ge 3) {
            $suspicious = $true
            $reasons += "Multiple suspicious class names found"
            $hits += $cls.Hits
        }

    } catch {
        $reasons += "Scan error"
    } finally {
        Remove-Item $temp -Recurse -Force -ErrorAction SilentlyContinue
    }

    [PSCustomObject]@{
        ModName      = $ModName
        IsSuspicious = $suspicious
        Reason       = $reasons -join "; "
        Hits         = $hits | Select-Object -Unique
    }
}

# ORIGINAL Scan-CheatPackages + Scan-SuspiciousClasses
# >>> 그대로 사용 <<<

Start-CheatScan
