# Achtung: Dieses Skript löscht Dateien dauerhaft!
# Bitte vorher mit -WhatIf testen

param(
    [switch]$WhatIf,
    [switch]$Verbose
)

# Suchmuster für Dateien und Ordner
$searchPatterns = @(
    "*clickcrystal*",
    "*krypton*", 
    "*argon*",
    "*system.b1.6*"
)

# Erweiterungen, die durchsucht werden sollen (anpassbar)
$extensions = @("*.exe", "*.dll", "*.zip", "*.rar", "*.7z", "*.msi", "*.bat", "*.ps1", "*.cmd")

# Verzeichnisse, die durchsucht werden sollen (mit Ausnahmen)
$searchPaths = @(
    $env:USERPROFILE,
    "C:\Program Files",
    "C:\Program Files (x86)",
    "$env:USERPROFILE\Downloads",
    "$env:USERPROFILE\Desktop"
)

# Auszuschließende Verzeichnisse (Systemverzeichnisse)
$excludedPaths = @(
    "C:\Windows",
    "C:\ProgramData",
    "$env:USERPROFILE\AppData\Local\Temp"
)

$deletedItems = @()
$errors = @()

Write-Host "=== Dateien löschen Skript ===" -ForegroundColor Cyan
Write-Host "Suche nach: clickcrystal, krypton, argon, system.b1.6"
Write-Host ""

if ($WhatIf) {
    Write-Host "TESTMODUS: Es wird nichts gelöscht (WhatIf aktiviert)" -ForegroundColor Yellow
    Write-Host ""
}

foreach ($path in $searchPaths) {
    if (-not (Test-Path $path)) {
        Write-Verbose "Pfad existiert nicht: $path"
        continue
    }
    
    foreach ($pattern in $searchPatterns) {
        try {
            # Suche nach Dateien mit den Mustern
            $files = Get-ChildItem -Path $path -Recurse -Force -ErrorAction SilentlyContinue | 
                    Where-Object { 
                        $_.Name -like $pattern -or 
                        $_.Name -like "*$pattern*" -or
                        $_.FullName -like "*$pattern*"
                    }
            
            foreach ($file in $files) {
                $skip = $false
                
                # Überprüfe, ob Datei in ausgeschlossenem Pfad liegt
                foreach ($excluded in $excludedPaths) {
                    if ($file.FullName -like "$excluded*") {
                        $skip = $true
                        Write-Verbose "Überspringe (ausgeschlossen): $($file.FullName)"
                        break
                    }
                }
                
                if (-not $skip) {
                    if ($WhatIf) {
                        Write-Host "[WHATIF] Würde löschen: $($file.FullName)" -ForegroundColor Gray
                        $deletedItems += $file.FullName
                    } else {
                        try {
                            Remove-Item -Path $file.FullName -Force -Recurse -ErrorAction Stop
                            Write-Host "[GELÖSCHT] $($file.FullName)" -ForegroundColor Red
                            $deletedItems += $file.FullName
                        } catch {
                            $errors += "Fehler beim Löschen von $($file.FullName): $_"
                            Write-Host "[FEHLER] $($file.FullName)" -ForegroundColor Yellow
                        }
                    }
                }
            }
            
            # Suche auch in bestimmten Registry-Pfaden (optional)
            if (-not $WhatIf) {
                $registryPaths = @(
                    "HKCU:\Software",
                    "HKLM:\SOFTWARE"
                )
                
                foreach ($regPath in $registryPaths) {
                    if (Test-Path $regPath) {
                        $regKeys = Get-ChildItem -Path $regPath -Recurse -ErrorAction SilentlyContinue | 
                                  Where-Object { $_.Name -like "*$pattern*" }
                        
                        foreach ($key in $regKeys) {
                            try {
                                Remove-Item -Path $key.PSPath -Force -Recurse -ErrorAction Stop
                                Write-Host "[REGISTRY] Gelöscht: $($key.Name)" -ForegroundColor Magenta
                            } catch {
                                # Registry-Einträge können geschützt sein
                            }
                        }
                    }
                }
            }
            
        } catch {
            $errors += "Fehler beim Durchsuchen von $path nach $pattern : $_"
        }
    }
}

# Zusammenfassung
Write-Host ""
Write-Host "=== ZUSAMMENFASSUNG ===" -ForegroundColor Cyan

if ($deletedItems.Count -gt 0) {
    Write-Host "Gefundene/gelöschte Elemente: $($deletedItems.Count)" -ForegroundColor White
    
    if ($Verbose) {
        foreach ($item in $deletedItems) {
            Write-Host "  - $item" -ForegroundColor Gray
        }
    }
} else {
    Write-Host "Keine passenden Elemente gefunden." -ForegroundColor Green
}

if ($errors.Count -gt 0) {
    Write-Host ""
    Write-Host "Fehler aufgetreten: $($errors.Count)" -ForegroundColor Yellow
    foreach ($error in $errors) {
        Write-Host "  - $error" -ForegroundColor Yellow
    }
}

if ($WhatIf) {
    Write-Host ""
    Write-Host "Hinweis: Skript im Testmodus ausgeführt." -ForegroundColor Yellow
    Write-Host "Um wirklich zu löschen, ohne -WhatIf Parameter ausführen." -ForegroundColor Yellow
}
