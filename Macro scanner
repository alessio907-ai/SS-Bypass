# =====================================================
# Recently Deleted JAR Files Scanner
# Zeigt alle in den letzten 10 Minuten gel√∂schten JAR-Dateien
# =====================================================

$ErrorActionPreference = "SilentlyContinue"

# ---------------- UI HELPERS ----------------
function H1($t){
    Write-Host ""
    Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor DarkBlue
    Write-Host " $t" -ForegroundColor Cyan
    Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor DarkBlue
    Write-Host ""
}
function Sec($t){ Write-Host "`n--- $t ---" -ForegroundColor Cyan }
function Info($t){ Write-Host "  $t" -ForegroundColor Blue }
function Bad($t){ Write-Host "  $t" -ForegroundColor Red }
function Warn($t){ Write-Host "  $t" -ForegroundColor Yellow }
function Good($t){ Write-Host "  $t" -ForegroundColor Green }

# ---------------- ENTRY ----------------
function Start-JarDeletionScan {
    Clear-Host
    H1 "Recently Deleted JAR Files Scanner"
    Info "Zeigt alle in den letzten 10 Minuten gel√∂schten JAR-Dateien"
    Write-Host ""
    
    # --------- SYSTEM INFO ----------
    $computerName = $env:COMPUTERNAME
    $userName = $env:USERNAME
    $timeNow = Get-Date
    
    Sec "System Information"
    Info "Computer: $computerName"
    Info "Benutzer: $userName"
    Info "Aktuelle Zeit: $timeNow"
    
    # --------- SCAN PARAMETERS ----------
    $minutesBack = 10
    $startTime = $timeNow.AddMinutes(-$minutesBack)
    
    Sec "Scan Parameter"
    Info "Zeitraum: Letzte $minutesBack Minuten (seit $startTime)"
    Info "Suche nach: *.jar Dateien im gesamten System"
    
    # --------- SCAN FOR RECENTLY DELETED JARS ----------
    Sec "Scanning for recently deleted JAR files..."
    
    # 1. ERSTE METHODE: Event Log Analyse (Windows Ereignisprotokolle)
    $deletedJarsFromEvents = @()
    
    try {
        Write-Host "`n[1/3] Pr√ºfe Windows Ereignisprotokolle..." -ForegroundColor Cyan
        
        # PowerShell 5.1+ Methode
        $events = Get-WinEvent -FilterHashtable @{
            LogName = 'Security'
            ID = 4663
            StartTime = $startTime
        } -ErrorAction SilentlyContinue | Where-Object {
            $_.Properties[6].Value -like "*.jar" -and
            $_.Properties[2].Value -eq "%%1537"  # DELETE Zugriff
        }
        
        foreach ($event in $events) {
            $filePath = $event.Properties[6].Value
            $user = $event.Properties[1].Value
            $time = $event.TimeCreated
            
            $deletedJarsFromEvents += [PSCustomObject]@{
                FilePath = $filePath
                User = $user
                TimeDeleted = $time
                Source = "Event Log"
            }
        }
        
        Info "  Ereignisprotokolle durchsucht: $($events.Count) relevante Eintr√§ge"
    } catch {
        Warn "  Ereignisprotokolle nicht verf√ºgbar: $($_.Exception.Message)"
    }
    
    # 2. ZWEITE METHODE: Volume Shadow Copy (VSS) - Gel√∂schte Dateien wiederherstellen
    $deletedJarsFromShadow = @()
    
    try {
        Write-Host "`n[2/3] Pr√ºfe Volume Shadow Copies..." -ForegroundColor Cyan
        
        # Liste aller Laufwerke
        $drives = Get-PSDrive -PSProvider FileSystem | Where-Object Root
        
        foreach ($drive in $drives) {
            $driveLetter = $drive.Root.TrimEnd('\')
            
            try {
                # Versuche VSS Snapshots zu listen
                $vssAdmin = cmd /c "vssadmin list shadows /for=$driveLetter 2>nul"
                
                if ($vssAdmin -match "Shadow Copy Volume:") {
                    # Suche nach JAR Dateien in VSS
                    $shadowPath = "\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy"
                    
                    # Einfache Suche in typischen Minecraft/Mod-Ordnern
                    $commonPaths = @(
                        "$driveLetter\Users\$userName\AppData\Roaming\.minecraft\mods",
                        "$driveLetter\Users\$userName\AppData\Roaming\.minecraft\versions",
                        "$driveLetter\Program Files (x86)\Minecraft",
                        "$driveLetter\Program Files\Minecraft",
                        "$driveLetter\Users\$userName\Desktop",
                        "$driveLetter\Users\$userName\Downloads",
                        "$driveLetter\Users\$userName\Documents"
                    )
                    
                    foreach ($path in $commonPaths) {
                        $shadowPathFull = $path -replace "^$driveLetter", $shadowPath
                        if (Test-Path $shadowPathFull -ErrorAction SilentlyContinue) {
                            $oldJars = Get-ChildItem -Path $shadowPathFull -Filter "*.jar" -Recurse -ErrorAction SilentlyContinue
                            
                            foreach ($jar in $oldJars) {
                                $currentPath = $jar.FullName -replace [regex]::Escape($shadowPath), $driveLetter
                                
                                # Pr√ºfe ob Datei aktuell nicht existiert (gel√∂scht)
                                if (-not (Test-Path $currentPath -ErrorAction SilentlyContinue)) {
                                    $deletedJarsFromShadow += [PSCustomObject]@{
                                        FilePath = $currentPath
                                        User = $userName
                                        TimeDeleted = "Unbekannt (VSS)"
                                        Source = "Volume Shadow Copy"
                                        OriginalPath = $jar.FullName
                                    }
                                }
                            }
                        }
                    }
                }
            } catch {
                # Ignoriere Fehler bei diesem Laufwerk
            }
        }
        
        Info "  Shadow Copies durchsucht: $($deletedJarsFromShadow.Count) gel√∂schte JARs gefunden"
    } catch {
        Warn "  Shadow Copy Zugriff nicht m√∂glich"
    }
    
    # 3. DRITTE METHODE: Prefetch und Temp Dateien Analyse
    $deletedJarsFromTemp = @()
    
    try {
        Write-Host "`n[3/3] Pr√ºfe tempor√§re Dateien und Prefetch..." -ForegroundColor Cyan
        
        # Prefetch Dateien (enth√§lt geladene Programme)
        $prefetchPath = "C:\Windows\Prefetch"
        if (Test-Path $prefetchPath) {
            $prefetchFiles = Get-ChildItem -Path $prefetchPath -Filter "*.pf" -ErrorAction SilentlyContinue | 
                Where-Object LastWriteTime -gt $startTime
            
            foreach ($pf in $prefetchFiles) {
                # Versuche Java/Minecraft bezogene Prefetch zu finden
                $content = Get-Content $pf.FullName -Raw -ErrorAction SilentlyContinue
                if ($content -match "java\.exe|javaw\.exe|minecraft") {
                    # Extrahierte Pfade aus Prefetch k√∂nnten gel√∂schte JARs enthalten
                    $deletedJarsFromTemp += [PSCustomObject]@{
                        FilePath = "Prefetch Hinweis: $($pf.Name)"
                        User = $userName
                        TimeDeleted = $pf.LastWriteTime
                        Source = "Prefetch Analysis"
                        Note = "Java/Minecraft Aktivit√§t erkannt"
                    }
                }
            }
        }
        
        # Temp Verzeichnisse
        $tempPaths = @(
            $env:TEMP,
            "C:\Windows\Temp",
            "C:\Users\$userName\AppData\Local\Temp"
        )
        
        foreach ($tempPath in $tempPaths) {
            if (Test-Path $tempPath) {
                # Suche nach k√ºrzlich gel√∂schten JARs in Temp (durch Namen)
                $tempFiles = Get-ChildItem -Path $tempPath -Filter "*.jar" -Recurse -ErrorAction SilentlyContinue |
                    Where-Object LastWriteTime -gt $startTime
                
                foreach ($tempFile in $tempFiles) {
                    $deletedJarsFromTemp += [PSCustomObject]@{
                        FilePath = $tempFile.FullName
                        User = $userName
                        TimeDeleted = $tempFile.LastWriteTime
                        Source = "Temp Directory"
                        Note = "M√∂glicherweise gel√∂schte/r verschobene/r JAR"
                    }
                }
            }
        }
        
        Info "  Temp/Prefetch analysiert: $($deletedJarsFromTemp.Count) Hinweise"
    } catch {
        Warn "  Temp/Prefetch Analyse fehlgeschlagen"
    }
    
    # --------- GESAMTERGEBNISSE ----------
    $allDeletedJars = $deletedJarsFromEvents + $deletedJarsFromShadow + $deletedJarsFromTemp
    
    Sec "ERGEBNISSE: Gel√∂schte JAR-Dateien (letzte $minutesBack Minuten)"
    
    if ($allDeletedJars.Count -eq 0) {
        Good "‚úî Keine gel√∂schten JAR-Dateien in den letzten $minutesBack Minuten gefunden."
    } else {
        # Gruppiere nach Quelle
        $groupedResults = $allDeletedJars | Group-Object Source
        
        foreach ($group in $groupedResults) {
            Sec "$($group.Name) - $($group.Count) Datei(en)"
            
            foreach ($jar in $group.Group | Sort-Object TimeDeleted -Descending) {
                $timeAgo = if ($jar.TimeDeleted -ne "Unbekannt (VSS)") {
                    $ago = $timeNow - $jar.TimeDeleted
                    "$([math]::Round($ago.TotalMinutes, 1)) Minuten her"
                } else {
                    "Unbekannt"
                }
                
                Write-Host "  üìÑ " -NoNewline -ForegroundColor Cyan
                Write-Host "$(Split-Path $jar.FilePath -Leaf)" -NoNewline -ForegroundColor White
                Write-Host " (" -NoNewline
                Write-Host "$timeAgo" -NoNewline -ForegroundColor Yellow
                Write-Host ")" -NoNewline
                
                if ($jar.Note) {
                    Write-Host " - $($jar.Note)" -ForegroundColor Gray
                } else {
                    Write-Host ""
                }
                
                Write-Host "      Pfad: " -NoNewline -ForegroundColor DarkGray
                Write-Host "$($jar.FilePath)" -ForegroundColor Gray
                
                if ($jar.User) {
                    Write-Host "      Benutzer: $($jar.User)" -ForegroundColor DarkGray
                }
            }
        }
        
        # STATISTIK
        Sec "STATISTIK"
        Info "Total gel√∂schte JARs: $($allDeletedJars.Count)"
        Info "Aus Event Log: $($deletedJarsFromEvents.Count)"
        Info "Aus Shadow Copies: $($deletedJarsFromShadow.Count)"
        Info "Aus Temp/Prefetch: $($deletedJarsFromTemp.Count)"
        
        # VERD√ÑCHTIGE DATEIEN FILTERN
        $suspiciousPatterns = @(
            "cheat", "hack", "client", "aura", "crystal", "trigger", 
            "auto", "reach", "velocity", "xray", "esp", "meteor",
            "wurst", "aristois", "future", "rusher", "liquidbounce"
        )
        
        $suspiciousJars = $allDeletedJars | Where-Object {
            $fileName = Split-Path $_.FilePath -Leaf
            foreach ($pattern in $suspiciousPatterns) {
                if ($fileName -match $pattern) {
                    return $true
                }
            }
            return $false
        }
        
        if ($suspiciousJars.Count -gt 0) {
            Sec "‚ö† VERD√ÑCHTIGE GEL√ñSCHTE DATEIEN"
            foreach ($jar in $suspiciousJars) {
                Warn "  ‚ö† $($jar.FilePath)"
                Warn "    Grund: Name enth√§lt verd√§chtige Schl√ºsselw√∂rter"
            }
        }
    }
    
    # --------- EMPFEHLUNGEN ----------
    Sec "EMPFEHLUNGEN"
    
    if ($allDeletedJars.Count -gt 5) {
        Warn "  üîç Viele JAR-Dateien wurden k√ºrzlich gel√∂scht ($($allDeletedJars.Count))"
        Warn "    M√∂glicherweise wurden Cheats vor einem Screenshot entfernt"
    }
    
    if ($suspiciousJars.Count -gt 0) {
        Bad "  ‚ö† Verd√§chtige JAR-Namen gefunden!"
        Bad "    Wahrscheinlich wurden Cheat-Mods entfernt"
    }
    
    Info "  üìÅ Tipp: √úberpr√ºfe den Papierkorb auf gel√∂schte Dateien"
    Info "  üîÑ Starte den Scan erneut, um neue L√∂schungen zu finden"
    
    # --------- WEITERE OPTIONEN ----------
    Sec "WEITERE AKTIONEN"
    Write-Host "  1. Papierkorb durchsuchen" -ForegroundColor Cyan
    Write-Host "  2. Erneut scannen (andere Zeit)" -ForegroundColor Cyan
    Write-Host "  3. Event Log detailliert anzeigen" -ForegroundColor Cyan
    Write-Host "  4. Beenden" -ForegroundColor Cyan
    
    $choice = Read-Host "`nAuswahl (1-4)"
    
    switch ($choice) {
        "1" { Search-RecycleBin }
        "2" { 
            $newMinutes = Read-Host "Wie viele Minuten zur√ºck suchen? (Standard: 10)"
            if ($newMinutes -match '^\d+$') {
                $minutesBack = [int]$newMinutes
                Start-JarDeletionScan
            }
        }
        "3" { Show-EventLogDetails }
        "4" { return }
        default { Write-Host "Ung√ºltige Auswahl" -ForegroundColor Red }
    }
}

# ---------------- HELPER FUNCTIONS ----------------
function Search-RecycleBin {
    Clear-Host
    H1 "Papierkorb durchsuchen"
    
    Info "Suche nach JAR-Dateien im Papierkorb..."
    
    # PowerShell 5.1+ Shell.Application Methode
    $shell = New-Object -ComObject Shell.Application
    $recycleBin = $shell.Namespace(0xA)  # Recycle Bin
    
    $jarFiles = @()
    
    foreach ($item in $recycleBin.Items()) {
        if ($item.Path -like "*.jar") {
            $jarFiles += [PSCustomObject]@{
                Name = $item.Name
                OriginalLocation = $item.ExtendedProperty("DateCreated")  # Nicht immer verf√ºgbar
                Size = "{0:N2} MB" -f ($item.Size / 1MB)
                DateDeleted = $item.ModifyDate
                Path = $item.Path
            }
        }
    }
    
    if ($jarFiles.Count -eq 0) {
        Good "‚úî Keine JAR-Dateien im Papierkorb gefunden."
    } else {
        Sec "JAR-Dateien im Papierkorb: $($jarFiles.Count)"
        
        foreach ($jar in $jarFiles | Sort-Object DateDeleted -Descending) {
            Write-Host "  üóëÔ∏è " -NoNewline -ForegroundColor Yellow
            Write-Host "$($jar.Name)" -ForegroundColor White
            Write-Host "    Gel√∂scht am: $($jar.DateDeleted)" -ForegroundColor Gray
            Write-Host "    Gr√∂√üe: $($jar.Size)" -ForegroundColor Gray
            
            # Versuche, die Datei zu analysieren
            if (Test-Path $jar.Path) {
                $fileInfo = Get-Item $jar.Path -ErrorAction SilentlyContinue
                if ($fileInfo) {
                    $hash = Get-FileHash $jar.Path -Algorithm SHA1 -ErrorAction SilentlyContinue
                    if ($hash) {
                        Write-Host "    SHA1: $($hash.Hash)" -ForegroundColor DarkGray
                    }
                }
            }
        }
    }
    
    Read-Host "`nDr√ºcke Enter um fortzufahren"
    Start-JarDeletionScan
}

function Show-EventLogDetails {
    Clear-Host
    H1 "Detaillierte Event Log Analyse"
    
    Sec "Suche nach Datei-L√∂sch-Ereignissen..."
    
    $startTime = (Get-Date).AddMinutes(-10)
    
    try {
        # Erweiterte Event Log Suche
        $events = Get-WinEvent -FilterHashtable @{
            LogName = 'Security'
            ID = 4663  # File Delete
            StartTime = $startTime
        } -MaxEvents 50 -ErrorAction SilentlyContinue
        
        $fileEvents = @()
        
        foreach ($event in $events) {
            $properties = $event.Properties
            
            $filePath = $properties[6].Value
            $user = $properties[1].Value
            $process = $properties[5].Value
            $accessMask = $properties[2].Value
            
            # Nur DELETE Operationen (0x10000)
            if ($accessMask -eq "%%1537" -or $filePath -like "*.jar") {
                $fileEvents += [PSCustomObject]@{
                    Time = $event.TimeCreated
                    User = $user
                    Process = Split-Path $process -Leaf
                    FilePath = $filePath
                    EventID = $event.Id
                }
            }
        }
        
        if ($fileEvents.Count -eq 0) {
            Info "Keine Datei-L√∂sch-Ereignisse in den letzten 10 Minuten gefunden."
        } else {
            Sec "Datei-L√∂sch-Ereignisse (letzte 10 Minuten): $($fileEvents.Count)"
            
            $jarEvents = $fileEvents | Where-Object { $_.FilePath -like "*.jar" }
            $otherEvents = $fileEvents | Where-Object { $_.FilePath -notlike "*.jar" }
            
            if ($jarEvents.Count -gt 0) {
                Write-Host "`nJAR-Datei L√∂schungen:" -ForegroundColor Cyan
                foreach ($event in $jarEvents | Sort-Object Time -Descending) {
                    Write-Host "  ‚è∞ $($event.Time)" -ForegroundColor Yellow
                    Write-Host "    üìÑ $(Split-Path $event.FilePath -Leaf)" -ForegroundColor White
                    Write-Host "    üë§ $($event.User)" -ForegroundColor Gray
                    Write-Host "    ‚öôÔ∏è $($event.Process)" -ForegroundColor DarkGray
                    Write-Host "    üìÅ $($event.FilePath)" -ForegroundColor DarkGray
                }
            }
            
            if ($otherEvents.Count -gt 0) {
                Write-Host "`nAndere Datei-L√∂schungen:" -ForegroundColor Cyan
                foreach ($event in $otherEvents | Sort-Object Time -Descending | Select-Object -First 10) {
                    Write-Host "  $($event.Time) - $(Split-Path $event.FilePath -Leaf)" -ForegroundColor Gray
                }
                if ($otherEvents.Count -gt 10) {
                    Write-Host "    ... und $($otherEvents.Count - 10) weitere" -ForegroundColor DarkGray
                }
            }
        }
        
    } catch {
        Bad "Event Log Zugriff fehlgeschlagen: $($_.Exception.Message)"
    }
    
    Read-Host "`nDr√ºcke Enter um fortzufahren"
    Start-JarDeletionScan
}

# ---------------- ERWEITERTE FUNKTIONEN ----------------
function Check-JavaProcessHistory {
    Sec "Java Prozess Historie"
    
    # Pr√ºfe auf k√ºrzlich beendete Java-Prozesse
    $recentJavaProcesses = Get-WinEvent -FilterHashtable @{
        LogName = 'System'
        ID = 4689  # Process Termination
        StartTime = (Get-Date).AddMinutes(-10)
    } -ErrorAction SilentlyContinue | Where-Object {
        $_.Properties[5].Value -match "java(\.exe|w\.exe)?"
    }
    
    if ($recentJavaProcesses.Count -gt 0) {
        Warn "  Java wurde k√ºrzlich $($recentJavaProcesses.Count) mal beendet"
        foreach ($proc in $recentJavaProcesses | Select-Object -First 3) {
            Write-Host "    ‚è∞ $($proc.TimeCreated) - $($proc.Properties[0].Value)" -ForegroundColor Gray
        }
    } else {
        Info "  Keine k√ºrzlichen Java-Prozess-Beendigungen"
    }
}

function Monitor-RealTimeDeletions {
    Clear-Host
    H1 "Echtzeit √úberwachung von JAR L√∂schungen"
    Info "√úberwacht das System auf JAR Datei-L√∂schungen..."
    Write-Host "Dr√ºcke Ctrl+C zum Beenden`n"
    
    $monitorTime = 300  # 5 Minuten
    $endTime = (Get-Date).AddSeconds($monitorTime)
    
    Write-Host "√úberwachung l√§uft f√ºr $($monitorTime/60) Minuten..." -ForegroundColor Cyan
    
    $deletionCount = 0
    
    while ((Get-Date) -lt $endTime) {
        $currentTime = Get-Date -Format "HH:mm:ss"
        Write-Host "`r[$currentTime] √úberwache... (Noch $([math]::Round(($endTime - (Get-Date)).TotalSeconds))s)" -NoNewline -ForegroundColor DarkGray
        
        # Pr√ºfe Event Log f√ºr neue L√∂schungen
        try {
            $newEvents = Get-WinEvent -FilterHashtable @{
                LogName = 'Security'
                ID = 4663
                StartTime = (Get-Date).AddSeconds(-5)
            } -ErrorAction SilentlyContinue | Where-Object {
                $_.Properties[6].Value -like "*.jar"
            }
            
            foreach ($event in $newEvents) {
                $deletionCount++
                Write-Host "`n  ‚ö† JAR gel√∂scht: $($event.Properties[6].Value)" -ForegroundColor Red
                Write-Host "    Zeit: $($event.TimeCreated)" -ForegroundColor Yellow
            }
        } catch {
            # Ignoriere Fehler
        }
        
        Start-Sleep -Seconds 2
    }
    
    Write-Host "`n`n√úberwachung beendet." -ForegroundColor Cyan
    if ($deletionCount -gt 0) {
        Warn "  $deletionCount JAR-L√∂schungen w√§hrend der √úberwachung erkannt!"
    } else {
        Good "  Keine JAR-L√∂schungen w√§hrend der √úberwachung erkannt."
    }
    
    Read-Host "`nDr√ºcke Enter um fortzufahren"
    Start-JarDeletionScan
}

# ---------------- RUN ----------------
Start-JarDeletionScan
